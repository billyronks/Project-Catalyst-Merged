version: '3.8'

services:
  # LumaDB - Unified Data Layer
  lumadb:
    image: lumadb/lumadb:latest
    container_name: brivas-lumadb
    ports:
      - "5432:5432"   # PostgreSQL wire protocol
      - "6379:6379"   # Redis wire protocol
      - "27017:27017" # MongoDB wire protocol
      - "9092:9092"   # Kafka wire protocol
    environment:
      LUMADB_USER: brivas
      LUMADB_PASSWORD: ${LUMADB_PASSWORD:-brivas_secret}
      LUMADB_DATABASE: brivas
      LUMADB_ENABLE_POSTGRES: "true"
      LUMADB_ENABLE_REDIS: "true"
      LUMADB_ENABLE_KAFKA: "true"
      LUMADB_DATA_DIR: /data
    volumes:
      - lumadb_data:/data
      - ./migrations/lumadb:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "brivas"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - brivas-network

  # API Gateway - Unified API Layer
  api-gateway:
    build:
      context: .
      dockerfile: infrastructure/docker/Dockerfile.api-gateway
    container_name: brivas-api-gateway
    ports:
      - "8080:8080"
    environment:
      LUMADB_HOST: lumadb
      LUMADB_PORT: 5432
      LUMADB_USER: brivas
      LUMADB_PASSWORD: ${LUMADB_PASSWORD:-brivas_secret}
      LUMADB_DATABASE: brivas
      LUMADB_SSLMODE: disable
      API_PORT: 8080
      API_HOST: 0.0.0.0
      ENABLE_GRAPHQL: "true"
      ENABLE_REST: "true"
      ENABLE_WEBSOCKET: "true"
      ENABLE_MCP: "true"
      ENABLE_CORS: "true"
    depends_on:
      lumadb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - brivas-network

  # SMS Service - SMS Processing Engine
  sms-service:
    build:
      context: .
      dockerfile: infrastructure/docker/Dockerfile.sms-service
    container_name: brivas-sms-service
    ports:
      - "8081:8081"
    environment:
      LUMADB_HOST: lumadb
      LUMADB_PORT: 5432
      LUMADB_USER: brivas
      LUMADB_PASSWORD: ${LUMADB_PASSWORD:-brivas_secret}
      LUMADB_DATABASE: brivas
      KAFKA_BROKERS: lumadb:9092
      SERVICE_PORT: 8081
    depends_on:
      lumadb:
        condition: service_healthy
    networks:
      - brivas-network

  # Voice Service - Voice/Flash Call Engine
  voice-service:
    build:
      context: .
      dockerfile: infrastructure/docker/Dockerfile.voice-service
    container_name: brivas-voice-service
    ports:
      - "8082:8082"
    environment:
      LUMADB_HOST: lumadb
      LUMADB_PORT: 5432
      LUMADB_USER: brivas
      LUMADB_PASSWORD: ${LUMADB_PASSWORD:-brivas_secret}
      LUMADB_DATABASE: brivas
      SERVICE_PORT: 8082
    depends_on:
      lumadb:
        condition: service_healthy
    networks:
      - brivas-network

  # Billing Service - From Project Catalyst
  billing-service:
    build:
      context: .
      dockerfile: infrastructure/docker/Dockerfile.billing-service
    container_name: brivas-billing-service
    ports:
      - "8083:8083"
    environment:
      LUMADB_HOST: lumadb
      LUMADB_PORT: 5432
      LUMADB_USER: brivas
      LUMADB_PASSWORD: ${LUMADB_PASSWORD:-brivas_secret}
      LUMADB_DATABASE: brivas
      REDIS_HOST: lumadb
      REDIS_PORT: 6379
      KAFKA_BROKERS: lumadb:9092
      SERVICE_PORT: 8083
    depends_on:
      lumadb:
        condition: service_healthy
    networks:
      - brivas-network

  # AI Service - LLM Integration
  ai-service:
    build:
      context: .
      dockerfile: infrastructure/docker/Dockerfile.ai-service
    container_name: brivas-ai-service
    ports:
      - "8084:8084"
    environment:
      LUMADB_HOST: lumadb
      LUMADB_PORT: 5432
      LUMADB_USER: brivas
      LUMADB_PASSWORD: ${LUMADB_PASSWORD:-brivas_secret}
      LUMADB_DATABASE: brivas
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      LLAMA_ENDPOINT: ${LLAMA_ENDPOINT:-}
      SERVICE_PORT: 8084
    depends_on:
      lumadb:
        condition: service_healthy
    networks:
      - brivas-network

  # Customer Web Frontend
  customer-web:
    build:
      context: ./apps/customer-web
      dockerfile: Dockerfile
    container_name: brivas-customer-web
    ports:
      - "3000:3000"
    environment:
      NEXT_PUBLIC_API_URL: http://api-gateway:8080
      NEXT_PUBLIC_WS_URL: ws://api-gateway:8080/ws
    depends_on:
      - api-gateway
    networks:
      - brivas-network

  # Admin Dashboard
  admin-dashboard:
    build:
      context: ./apps/admin-dashboard
      dockerfile: Dockerfile
    container_name: brivas-admin-dashboard
    ports:
      - "3001:3000"
    environment:
      NEXT_PUBLIC_API_URL: http://api-gateway:8080
    depends_on:
      - api-gateway
    networks:
      - brivas-network

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: brivas-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./infrastructure/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./infrastructure/nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - api-gateway
      - customer-web
      - admin-dashboard
    networks:
      - brivas-network

volumes:
  lumadb_data:
    driver: local

networks:
  brivas-network:
    driver: bridge
