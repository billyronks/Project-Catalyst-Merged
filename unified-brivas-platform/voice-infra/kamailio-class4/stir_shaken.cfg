# ═══════════════════════════════════════════════════════════════════════════════
# voice-infra/kamailio-class4/stir_shaken.cfg
# STIR/SHAKEN Integration with Authentication Service
# ═══════════════════════════════════════════════════════════════════════════════

#!define STIR_SHAKEN_REST_URL "http://stir-shaken-service.brivas.svc.cluster.local:8080"

####### HTTP Async Client for STIR/SHAKEN Service #######

loadmodule "http_async_client.so"
loadmodule "jansson.so"

modparam("http_async_client", "workers", 8)
modparam("http_async_client", "connection_timeout", 500)  # 500ms
modparam("http_async_client", "tls_verify_host", 1)
modparam("http_async_client", "tls_verify_peer", 1)

####### STIR/SHAKEN Routes #######

# ─────────────────────────────────────────────────────────────────────────────
# Route: Sign outbound call with STIR/SHAKEN
# ─────────────────────────────────────────────────────────────────────────────

route[STIRSHAKEN_SIGN] {
    xlog("L_INFO", "STIR/SHAKEN: Signing call from $fU to $rU\n");
    
    # Build JSON request for signing service
    jansson_set("string", "orig_tn", "+$fU", "$var(sign_req)");
    jansson_set("string", "dest_tn", "+$rU", "$var(sign_req)");
    jansson_set("string", "call_id", "$ci", "$var(sign_req)");
    jansson_set("string", "pop_id", "POP_DEFAULT", "$var(sign_req)");
    
    # Determine attestation level
    if ($avp(carrier_authenticated) == 1) {
        jansson_set("int", "attestation_level", 1, "$var(sign_req)");  # A
    } else if ($avp(customer_authenticated) == 1) {
        jansson_set("int", "attestation_level", 2, "$var(sign_req)");  # B
    } else {
        jansson_set("int", "attestation_level", 3, "$var(sign_req)");  # C
    }
    
    # Call STIR/SHAKEN service
    $http_req(all) = $null;
    $http_req(hdr) = "Content-Type: application/json";
    $http_req(body) = $var(sign_req);
    $http_req(timeout) = 500;
    
    http_async_query("STIR_SHAKEN_REST_URL/v1/sign", "STIRSHAKEN_SIGN_REPLY");
}

route[STIRSHAKEN_SIGN_REPLY] {
    if ($http_ok != 1) {
        xlog("L_WARN", "STIR/SHAKEN: Signing service unavailable\n");
        $avp(stir_status) = "service_unavailable";
        return;
    }
    
    if ($http_rs != 200) {
        xlog("L_WARN", "STIR/SHAKEN: Signing failed with status $http_rs\n");
        $avp(stir_status) = "sign_failed";
        return;
    }
    
    # Parse response
    jansson_get("identity_header", $http_rb, "$var(identity_header)");
    jansson_get("attestation_level", $http_rb, "$var(attestation)");
    
    # Add Identity header to INVITE
    if ($var(identity_header) != $null && $var(identity_header) != "") {
        append_hf("Identity: $var(identity_header)\r\n");
        xlog("L_INFO", "STIR/SHAKEN: Added Identity header with attestation $var(attestation)\n");
        $avp(stir_status) = "signed";
    }
}

# ─────────────────────────────────────────────────────────────────────────────
# Route: Verify inbound call STIR/SHAKEN
# ─────────────────────────────────────────────────────────────────────────────

route[STIRSHAKEN_VERIFY] {
    if (!is_present_hf("Identity")) {
        xlog("L_INFO", "STIR/SHAKEN: No Identity header present\n");
        $avp(stir_status) = "no_identity";
        return;
    }
    
    $var(identity_header) = $hdr(Identity);
    
    xlog("L_INFO", "STIR/SHAKEN: Verifying call from $fU\n");
    
    # Build JSON request
    jansson_set("string", "identity_header", "$var(identity_header)", "$var(verify_req)");
    jansson_set("string", "from_tn", "+$fU", "$var(verify_req)");
    jansson_set("string", "to_tn", "+$rU", "$var(verify_req)");
    jansson_set("string", "call_id", "$ci", "$var(verify_req)");
    jansson_set("string", "pop_id", "POP_DEFAULT", "$var(verify_req)");
    
    # Call verification service
    $http_req(all) = $null;
    $http_req(hdr) = "Content-Type: application/json";
    $http_req(body) = $var(verify_req);
    $http_req(timeout) = 500;
    
    http_async_query("STIR_SHAKEN_REST_URL/v1/verify", "STIRSHAKEN_VERIFY_REPLY");
}

route[STIRSHAKEN_VERIFY_REPLY] {
    if ($http_ok != 1) {
        xlog("L_WARN", "STIR/SHAKEN: Verification service unavailable\n");
        $avp(stir_status) = "service_unavailable";
        return;
    }
    
    if ($http_rs != 200) {
        xlog("L_WARN", "STIR/SHAKEN: Verification failed\n");
        $avp(stir_status) = "verify_error";
        return;
    }
    
    # Parse response
    jansson_get("status", $http_rb, "$var(verify_status)");
    jansson_get("attestation_level", $http_rb, "$var(attestation)");
    jansson_get("signer_spc", $http_rb, "$var(signer_spc)");
    
    switch ($var(verify_status)) {
        case 1:  # VALID
            $avp(stir_status) = "verified";
            $avp(stir_attest) = $var(attestation);
            $avp(stir_spc) = $var(signer_spc);
            xlog("L_INFO", "STIR/SHAKEN: Verified with attestation $var(attestation)\n");
            break;
        case 2:  # INVALID_SIGNATURE
            $avp(stir_status) = "invalid_signature";
            break;
        case 3:  # EXPIRED
            $avp(stir_status) = "expired";
            break;
        case 4:  # CERT_REVOKED
            $avp(stir_status) = "cert_revoked";
            break;
        default:
            $avp(stir_status) = "unknown";
    }
    
    # Add verification headers for downstream
    append_hf("X-Stir-Shaken-Status: $avp(stir_status)\r\n");
}
