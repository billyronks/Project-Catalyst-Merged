#
# ENUM (E.164 Number Mapping) Configuration
# DNS-based number portability and routing
#

####### ENUM Module #######

loadmodule "enum.so"

modparam("enum", "domain_suffix", "e164.arpa")
modparam("enum", "tel_uri_params", "")
modparam("enum", "i_enum_suffix", "e164.arpa")

####### ENUM Lookup Routes #######

route[ENUM_LOOKUP] {
    $var(number) = $rU;

    # Normalize to E.164
    if ($var(number) !~ "^\+?[0-9]+$") {
        xlog("L_WARN", "ENUM: Invalid number format $var(number)\n");
        return -1;
    }

    # Remove leading +
    if ($var(number) =~ "^\+") {
        $var(number) = $(var(number){s.substr,1,0});
    }

    # ENUM lookup
    if (enum_query()) {
        xlog("L_INFO", "ENUM: Found $ru for $var(number)\n");
        return 1;
    }

    xlog("L_DBG", "ENUM: No record for $var(number)\n");
    return -1;
}

####### Infrastructure ENUM (I-ENUM) #######

route[IENUM_LOOKUP] {
    # I-ENUM for carrier routing
    # Uses private ENUM zones for carrier peering

    $var(number) = $rU;

    # Check carrier-specific ENUM zones
    # e.g., 1.2.3.4.5.carrier.enum.brivas.io
    
    if (i_enum_query()) {
        xlog("L_INFO", "I-ENUM: Carrier route found for $var(number)\n");
        return 1;
    }

    return -1;
}

####### Number Portability Database #######

# For markets without ENUM, query MNP database directly
route[MNP_DB_LOOKUP] {
    $var(number) = $rU;

    # Query LumaDB brivas_voice.number_portability table
    # Table structure:
    # - number: VARCHAR (E.164)
    # - original_carrier: VARCHAR
    # - current_carrier: VARCHAR
    # - porting_date: TIMESTAMP
    # - routing_number: VARCHAR

    # TODO: Implement avpops query to LumaDB

    if ($avp(mnp_routing_number) != $null) {
        xlog("L_INFO", "MNP: $var(number) ported, route via $avp(mnp_routing_number)\n");
        
        # Prepend routing number for ported call
        $rU = $avp(mnp_routing_number) + $var(number);
        return 1;
    }

    return -1;
}

####### Nigerian Number Portability #######

route[NP_NIGERIA] {
    # Nigerian MNP via NIPOST or direct carrier lookup
    
    $var(number) = $rU;

    # Nigerian mobile prefixes
    # 0803, 0806, 0813, 0816 - MTN
    # 0802, 0808, 0812, 0701 - Airtel
    # 0805, 0807, 0815, 0811 - Glo
    # 0809, 0817, 0818 - 9mobile

    # Extract prefix
    $var(prefix) = $(var(number){s.substr,0,4});

    # Query NP database for ported numbers
    # Non-ported numbers route by prefix
    
    route(MNP_DB_LOOKUP);
}

####### South African Number Portability #######

route[NP_SOUTH_AFRICA] {
    # SANC number portability lookup
    
    $var(number) = $rU;

    # ZA mobile: 27 6x, 27 7x, 27 8x
    if ($var(number) =~ "^27[678]") {
        route(MNP_DB_LOOKUP);
    }
}
