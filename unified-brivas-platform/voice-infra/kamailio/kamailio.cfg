#!KAMAILIO
#
# Kamailio SBC Configuration for Brivas Voice Platform
# Session Border Controller - Topology hiding, NAT, DoS protection
#

####### Global Parameters #######

debug=2
log_stderror=no
log_facility=LOG_LOCAL0

fork=yes
children=8
auto_aliases=no

# Listen interfaces
listen=udp:0.0.0.0:5060
listen=tcp:0.0.0.0:5060
listen=tls:0.0.0.0:5061
listen=udp:0.0.0.0:5080  # Internal to OpenSIPS

####### Modules Section #######

loadmodule "tm.so"
loadmodule "sl.so"
loadmodule "rr.so"
loadmodule "pv.so"
loadmodule "maxfwd.so"
loadmodule "textops.so"
loadmodule "siputils.so"
loadmodule "xlog.so"
loadmodule "sanity.so"
loadmodule "nathelper.so"
loadmodule "rtpengine.so"
loadmodule "htable.so"
loadmodule "pike.so"
loadmodule "tls.so"
loadmodule "dispatcher.so"
loadmodule "topoh.so"

####### Module Parameters #######

# Transaction module
modparam("tm", "fr_timer", 5000)
modparam("tm", "fr_inv_timer", 30000)
modparam("tm", "restart_fr_on_each_reply", 1)

# RTPEngine
modparam("rtpengine", "rtpengine_sock", "udp:127.0.0.1:22222")
modparam("rtpengine", "rtpengine_tout_ms", 1000)

# Dispatcher (load balancing to OpenSIPS cluster)
modparam("dispatcher", "list_file", "/etc/kamailio/dispatcher.list")
modparam("dispatcher", "ds_ping_interval", 10)
modparam("dispatcher", "ds_probing_mode", 1)
modparam("dispatcher", "ds_ping_method", "OPTIONS")

# Pike (DoS protection)
modparam("pike", "sampling_time_unit", 2)
modparam("pike", "reqs_density_per_unit", 30)
modparam("pike", "remove_latency", 4)

# TLS
modparam("tls", "config", "/etc/kamailio/tls.cfg")
modparam("tls", "tls_force_run", 1)

# Topology hiding
modparam("topoh", "mask_key", "Brivas2024SecretKey!")
modparam("topoh", "mask_ip", "10.0.0.1")
modparam("topoh", "mask_callid", 1)

# Hash table for blocklist
modparam("htable", "htable", "blocklist=>size=10;autoexpire=3600")

####### Routing Logic #######

request_route {
    # Per-IP DoS protection
    if (!pike_check_req()) {
        xlog("L_ALERT", "PIKE: Blocking $si - too many requests\n");
        $sht(blocklist=>$si) = 1;
        exit;
    }
    
    # Check blocklist
    if ($sht(blocklist=>$si) != $null) {
        xlog("L_WARN", "BLOCKLIST: Dropping from $si\n");
        exit;
    }
    
    # Sanity checks
    if (!sanity_check()) {
        xlog("L_WARN", "SANITY: Malformed SIP from $si:$sp\n");
        exit;
    }
    
    # Max forwards check
    if (!mf_process_maxfwd_header("10")) {
        sl_send_reply("483", "Too Many Hops");
        exit;
    }
    
    # Record route for in-dialog requests
    if (!is_method("REGISTER")) {
        record_route();
    }
    
    # Handle sequential requests (in-dialog)
    if (has_totag()) {
        if (loose_route()) {
            route(RELAY);
        } else {
            if (is_method("ACK")) {
                if (t_check_trans()) {
                    route(RELAY);
                    exit;
                }
            }
            sl_send_reply("404", "Not Found");
        }
        exit;
    }
    
    # CANCEL handling
    if (is_method("CANCEL")) {
        if (t_check_trans()) {
            t_relay();
        }
        exit;
    }
    
    t_check_trans();
    
    # NAT detection and handling
    if (nat_uac_test("19")) {
        if (is_method("REGISTER")) {
            fix_nated_register();
        } else {
            fix_nated_contact();
        }
        setflag(5); # NAT flag
    }
    
    # RTPEngine for media handling
    if (has_body("application/sdp")) {
        if (isflagset(5)) {
            rtpengine_manage("replace-origin replace-session-connection ICE=remove RTP/AVP");
        } else {
            rtpengine_manage("replace-origin replace-session-connection");
        }
    }
    
    # Topology hiding for outbound
    if (is_method("INVITE")) {
        topoh_mask_callid();
    }
    
    # Load balance to OpenSIPS cluster
    if (!ds_select_dst("1", "4")) {  # Group 1, round-robin with failure
        sl_send_reply("503", "Service Unavailable");
        exit;
    }
    
    t_on_failure("MANAGE_FAILURE");
    route(RELAY);
}

route[RELAY] {
    if (is_method("INVITE")) {
        t_on_failure("MANAGE_FAILURE");
    }
    
    if (!t_relay()) {
        sl_reply_error();
    }
}

failure_route[MANAGE_FAILURE] {
    if (t_is_canceled()) {
        exit;
    }
    
    # RTPEngine cleanup on failure
    if (has_body("application/sdp")) {
        rtpengine_delete();
    }
    
    # Try next OpenSIPS node
    if (ds_next_dst()) {
        xlog("L_INFO", "Failover to next OpenSIPS: $du\n");
        t_on_failure("MANAGE_FAILURE");
        t_relay();
        exit;
    }
    
    send_reply("503", "Service Unavailable");
}

# BYE handling - cleanup RTPEngine
onreply_route {
    if (has_body("application/sdp")) {
        rtpengine_manage("replace-origin replace-session-connection");
    }
    
    if (nat_uac_test("1")) {
        fix_nated_contact();
    }
}
