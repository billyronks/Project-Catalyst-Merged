# OpenSIPS Class 5 Configuration
# Voice-Switch-IM Integration for Retail/PBX/WebRTC

####### Global Parameters #########
debug_mode=no
log_level=3
log_stderror=no
log_facility=LOG_LOCAL1
children=4
auto_aliases=no
listen=udp:0.0.0.0:5080
listen=tcp:0.0.0.0:5080
listen=ws:0.0.0.0:5066
listen=wss:0.0.0.0:5067

tls_verify_client = 0
tls_require_client_certificate = 0

####### Modules Section ########

loadmodule "signaling.so"
loadmodule "sl.so"
loadmodule "tm.so"
loadmodule "rr.so"
loadmodule "maxfwd.so"
loadmodule "textops.so"
loadmodule "sipmsgops.so"
loadmodule "mi_fifo.so"
loadmodule "uri.so"
loadmodule "db_postgres.so"
loadmodule "auth.so"
loadmodule "auth_db.so"
loadmodule "usrloc.so"
loadmodule "registrar.so"
loadmodule "nathelper.so"
loadmodule "rtpengine.so"
loadmodule "dialog.so"
loadmodule "proto_ws.so"
loadmodule "proto_wss.so"
loadmodule "tls_mgm.so"
loadmodule "proto_tls.so"

####### Module Parameters ########

# ----- mi_fifo params -----
modparam("mi_fifo", "fifo_name", "/run/opensips/opensips_fifo")

# ----- tm params -----
modparam("tm", "fr_timeout", 30)
modparam("tm", "fr_inv_timeout", 120)

# ----- rr params -----
modparam("rr", "enable_full_lr", 1)
modparam("rr", "append_fromtag", 1)

# ----- usrloc params -----
modparam("usrloc", "db_mode", 2)
modparam("usrloc", "db_url", "postgres://brivas:password@lumadb:5432/brivas")
modparam("usrloc", "nat_bflag", "NAT")

# ----- auth_db params -----
modparam("auth_db", "db_url", "postgres://brivas:password@lumadb:5432/brivas")
modparam("auth_db", "password_column", "ha1")
modparam("auth_db", "calculate_ha1", 0)

# ----- registrar params -----
modparam("registrar", "max_contacts", 5)
modparam("registrar", "received_avp", "$avp(received)")

# ----- nathelper params -----
modparam("nathelper", "received_avp", "$avp(received)")
modparam("nathelper", "natping_interval", 30)

# ----- rtpengine params -----
modparam("rtpengine", "rtpengine_sock", "udp:rtpengine:22222")

# ----- dialog params -----
modparam("dialog", "db_mode", 1)
modparam("dialog", "db_url", "postgres://brivas:password@lumadb:5432/brivas")

####### Routing Logic ########

route {
    xlog("L_INFO", "OpenSIPS $rm from $fu to $rU\n");

    # Max forwards
    if (!mf_process_maxfwd_header(10)) {
        send_reply(483, "Too Many Hops");
        exit;
    }

    # Handle CANCEL
    if (is_method("CANCEL")) {
        if (t_check_trans())
            t_relay();
        exit;
    }

    # NAT detection
    if (nat_uac_test(127)) {
        setbflag("NAT");
        force_rport();
        if (is_method("REGISTER")) {
            fix_nated_register();
        } else {
            fix_nated_contact();
        }
    }

    # In-dialog requests
    if (has_totag()) {
        if (loose_route()) {
            if (is_method("INVITE")) {
                record_route();
            }
            route(RELAY);
        } else {
            send_reply(404, "Not Found");
        }
        exit;
    }

    # REGISTER handling
    if (is_method("REGISTER")) {
        route(REGISTRAR);
        exit;
    }

    # Record route for INVITE
    if (is_method("INVITE")) {
        record_route();
        create_dialog();
        
        # WebRTC handling
        if ($proto == "ws" || $proto == "wss") {
            setflag("WEBRTC");
            rtpengine_offer("replace-origin replace-session-connection ICE=force DTLS=passive");
        } else {
            rtpengine_offer("replace-origin replace-session-connection");
        }
    }

    # Lookup user location
    if (is_method("INVITE")) {
        if (!lookup("location")) {
            # Forward to Class 4 for off-net
            $du = "sip:kamailio:5060";
            route(RELAY);
            exit;
        }
    }

    route(RELAY);
}

route[REGISTRAR] {
    # Authenticate
    if (!www_authorize("brivas", "subscribers")) {
        www_challenge("brivas", 1);
        exit;
    }
    
    consume_credentials();
    
    # Save location
    if (!save("location")) {
        sl_reply_error();
        exit;
    }
    
    xlog("L_INFO", "Registration successful for $fu\n");
}

route[RELAY] {
    if (isflagset("NAT") && has_body("application/sdp")) {
        rtpengine_answer("replace-origin replace-session-connection");
    }
    
    if (!t_relay()) {
        sl_reply_error();
    }
}

onreply_route {
    if (has_body("application/sdp")) {
        if (isflagset("WEBRTC")) {
            rtpengine_answer("replace-origin replace-session-connection ICE=force DTLS=passive");
        } else if (isflagset("NAT")) {
            rtpengine_answer("replace-origin replace-session-connection");
        }
    }
    
    fix_nated_contact();
}

local_route {
    if (is_method("BYE")) {
        rtpengine_delete();
    }
}
