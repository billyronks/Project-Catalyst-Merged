#
# Toll-Free Number Handling
# Routing for 1800, 1300, 0800, etc.
#

####### Toll-Free Configuration #######

# Toll-free numbers stored in LumaDB brivas_voice.tollfree_numbers table
# Table structure:
# - id: UUID
# - number: VARCHAR (E.164 format)
# - owner_tenant_id: UUID
# - did_provider: VARCHAR
# - destination_type: ENUM (SIP, PSTN, IVR)
# - destination_uri: VARCHAR
# - time_of_day_routing: JSONB
# - enabled: BOOLEAN
# - created_at: TIMESTAMP

####### Toll-Free Patterns #######

# US/CA: 1800, 1833, 1844, 1855, 1866, 1877, 1888
# UK: 0800, 0808
# AU: 1800, 1300
# ZA: 0800
# NG: (custom patterns via operator)

####### Toll-Free Routing #######

route[TOLLFREE_LOOKUP] {
    $var(tfn) = $rU;

    # Normalize toll-free number
    if ($var(tfn) =~ "^1?8[0-9]{2}[0-9]{7}$") {
        # US/CA toll-free
        if ($var(tfn) !~ "^1") {
            $var(tfn) = "1" + $var(tfn);
        }
    }

    # Query LumaDB for toll-free destination
    # $avp(tfn_dest_type) = destination type
    # $avp(tfn_dest_uri) = destination URI

    # TODO: Implement actual LumaDB query via avpops

    if ($avp(tfn_dest_uri) == $null) {
        xlog("L_WARN", "Toll-free $var(tfn) not found\n");
        sl_send_reply("404", "Number Not In Service");
        exit;
    }

    xlog("L_INFO", "Toll-free $var(tfn) -> $avp(tfn_dest_uri)\n");

    # Route based on destination type
    switch ($avp(tfn_dest_type)) {
        case "SIP":
            $ru = $avp(tfn_dest_uri);
            route(RELAY);
            break;
        case "IVR":
            # Send to IVR system
            $ru = "sip:" + $var(tfn) + "@ivr.brivas.local";
            route(RELAY);
            break;
        case "PSTN":
            # Route via carrier
            $rU = $avp(tfn_dest_uri);
            route(LCR_LOOKUP);
            route(RELAY);
            break;
    }
}

####### Toll-Free Time-of-Day Routing #######

route[TOLLFREE_TOD] {
    # Apply time-of-day routing rules
    # Based on brivas_voice.tollfree_numbers.time_of_day_routing

    $var(hour) = $timef(%H);
    $var(dow) = $timef(%u);  # 1=Monday, 7=Sunday

    # Default: business hours (9-17 weekdays)
    if ($var(dow) >= 6 || $var(hour) < 9 || $var(hour) >= 17) {
        # After hours routing
        if ($avp(tfn_after_hours_uri) != $null) {
            $ru = $avp(tfn_after_hours_uri);
        }
    }
}

####### Toll-Free Billing #######

route[TOLLFREE_BILLING] {
    # Toll-free calls are billed to the number owner
    # Store billing info for CDR

    $avp(billing_party) = "called";  # Owner pays
    $avp(tfn_owner) = $avp(tfn_owner_id);

    xlog("L_DBG", "Toll-free billing to owner $avp(tfn_owner)\n");
}
