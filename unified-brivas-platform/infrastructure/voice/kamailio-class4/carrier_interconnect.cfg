#
# Carrier Interconnect Configuration
# Authentication, trunk management, and peering
#

####### Carrier Trunk Database #######

# Carrier trunks are stored in LumaDB brivas_voice.carrier_trunks table
# Table structure:
# - id: UUID
# - carrier_name: VARCHAR
# - trunk_group: INTEGER (dispatcher group ID)
# - gateway_ip: INET
# - gateway_port: INTEGER
# - username: VARCHAR (for authentication)
# - password: VARCHAR (encrypted)
# - realm: VARCHAR
# - protocol: ENUM (UDP, TCP, TLS)
# - max_channels: INTEGER
# - cps_limit: INTEGER (calls per second)
# - enabled: BOOLEAN
# - priority: INTEGER
# - weight: INTEGER

####### Carrier Groups #######

# Group 1: Tier 1 International (Low-cost)
# Group 2: Tier 1 Domestic (Quality)
# Group 3: Premium (High quality, higher cost)
# Group 4: Backup/Overflow

####### Authentication Routes #######

route[CARRIER_AUTH] {
    # Check if source IP is in trusted carriers
    if (allow_source_address("carrier_peers")) {
        xlog("L_INFO", "Trusted carrier peer: $si\n");
        return;
    }

    # IP:port authentication
    if (!allow_source_address("carrier_trunks")) {
        # Try digest auth
        if (!proxy_authorize("carrier", "carrier_credentials")) {
            proxy_challenge("carrier", "1");
            exit;
        }
        consume_credentials();
    }
}

# Outbound carrier authentication
route[CARRIER_OUTAUTH] {
    # Get credentials for target carrier from database
    # $avp(carrier_user) and $avp(carrier_pass) set by LCR lookup

    if ($avp(carrier_user) != $null) {
        uac_auth("$avp(carrier_user)", "$avp(carrier_pass)");
    }
}

####### Carrier Health Monitoring #######

route[CARRIER_HEALTH_CHECK] {
    # OPTIONS ping to all carriers
    # Disabled carriers are excluded from routing

    # TODO: Implement carrier health monitoring via Rust daemon
    # that updates carrier status in LumaDB
}

####### Carrier-Specific Transformations #######

# Each carrier may require specific header modifications
route[CARRIER_TRANSFORM] {
    $var(carrier) = $avp(dr_gw);

    switch ($var(carrier)) {
        case "MTN_NG":
            # MTN Nigeria specific requirements
            append_hf("X-MTN-Carrier: true\r\n");
            break;
        case "AIRTEL_NG":
            # Airtel Nigeria
            remove_hf("P-Asserted-Identity");
            break;
        case "GLO_NG":
            # Globacom Nigeria
            break;
        case "9MOBILE_NG":
            break;
        default:
            break;
    }
}

####### STIR/SHAKEN for Carrier Interconnect #######

# Enable STIR/SHAKEN attestation for outbound calls
route[STIRSHAKEN_SIGN] {
    # Only for US/CA destinations
    if ($rU =~ "^1[2-9]") {
        # Sign with B level attestation (partial)
        # Full attestation requires caller verification
        
        # TODO: Integrate with STIR/SHAKEN certificate service
        xlog("L_INFO", "STIR/SHAKEN signing for call to $rU\n");
    }
}

# Verify STIR/SHAKEN on inbound from carriers
route[STIRSHAKEN_VERIFY] {
    if ($hdr(Identity) != $null) {
        # Verify signature
        # TODO: Integrate with STIR/SHAKEN verification service
        xlog("L_INFO", "STIR/SHAKEN identity present: $hdr(Identity)\n");
    }
}
