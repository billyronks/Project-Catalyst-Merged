#
# Least Cost Routing (LCR) Configuration
# Included from main kamailio.cfg
#

####### LCR Module Parameters #######

# LCR rules are stored in LumaDB brivas_voice.lcr_routes table
# Table structure:
# - id: UUID
# - prefix: VARCHAR (destination prefix e.g., "234" for Nigeria)
# - from_pattern: VARCHAR (source pattern matching)
# - gateway_group: INTEGER (dispatcher group)
# - priority: INTEGER (lower = higher priority)
# - weight: INTEGER (load balancing weight)
# - enabled: BOOLEAN
# - valid_from: TIMESTAMP
# - valid_until: TIMESTAMP
# - rate_per_minute: DECIMAL (cost in USD)
# - connection_fee: DECIMAL
# - billing_increment: INTEGER (seconds)

####### LCR Routing Functions #######

# Load LCR rules from database
# Called on startup and periodically via RPC
route[LCR_RELOAD] {
    xlog("L_INFO", "Reloading LCR routing tables\n");
    dr_reload();
}

# Main LCR lookup
route[LCR_LOOKUP] {
    $var(dest) = $rU;
    
    # Remove leading + if present
    if ($var(dest) =~ "^\+") {
        $var(dest) = $(var(dest){s.substr,1,0});
    }

    # Longest prefix match
    if (!do_routing("0", "$var(dest)")) {
        xlog("L_WARN", "LCR: No route for $var(dest)\n");
        return -1;
    }

    xlog("L_INFO", "LCR: Selected gateway group $avp(dr_gw) for $var(dest)\n");
    return 1;
}

# Rate lookup for billing
route[LCR_GET_RATE] {
    # Query rate from LumaDB
    # $avp(dr_rule) contains the matched rule ID
    
    # Default rates if not found
    $avp(rate_per_min) = 0.01;  # $0.01/min default
    $avp(conn_fee) = 0;
    $avp(billing_inc) = 6;  # 6-second increments
    
    xlog("L_DBG", "Rate for $rU: $avp(rate_per_min)/min\n");
}
