# Kamailio Class 4 Configuration
# Voice-Switch-IM Integration for Wholesale/LCR

####### Global Parameters #########
debug=2
log_stderror=no
log_facility=LOG_LOCAL0
fork=yes
children=8
auto_aliases=no
listen=udp:0.0.0.0:5060
listen=tcp:0.0.0.0:5060

####### Modules Section ########

loadmodule "sl.so"
loadmodule "tm.so"
loadmodule "rr.so"
loadmodule "pv.so"
loadmodule "maxfwd.so"
loadmodule "textops.so"
loadmodule "siputils.so"
loadmodule "xlog.so"
loadmodule "sanity.so"
loadmodule "nathelper.so"
loadmodule "rtpengine.so"
loadmodule "drouting.so"
loadmodule "lcr.so"
loadmodule "db_postgres.so"
loadmodule "uac_auth.so"
loadmodule "dialog.so"
loadmodule "htable.so"
loadmodule "statistics.so"
loadmodule "dispatcher.so"

####### Module Parameters ########

# ----- tm params -----
modparam("tm", "fr_timer", 30000)
modparam("tm", "fr_inv_timer", 120000)

# ----- rr params -----
modparam("rr", "enable_full_lr", 1)
modparam("rr", "append_fromtag", 1)

# ----- drouting params -----
modparam("drouting", "db_url", "postgres://brivas:password@lumadb:5432/brivas")
modparam("drouting", "ruri_avp", "$avp(dr_ruri)")
modparam("drouting", "gw_id_avp", "$avp(dr_gw_id)")
modparam("drouting", "attrs_avp", "$avp(dr_attrs)")
modparam("drouting", "rule_attrs_pvar", "$avp(dr_rule_attrs)")

# ----- lcr params -----
modparam("lcr", "db_url", "postgres://brivas:password@lumadb:5432/brivas")

# ----- rtpengine params -----
modparam("rtpengine", "rtpengine_sock", "udp:rtpengine:22222")

# ----- dialog params -----
modparam("dialog", "db_mode", 1)
modparam("dialog", "db_url", "postgres://brivas:password@lumadb:5432/brivas")
modparam("dialog", "dlg_flag", 4)
modparam("dialog", "track_cseq_updates", 1)

# ----- dispatcher params -----
modparam("dispatcher", "db_url", "postgres://brivas:password@lumadb:5432/brivas")
modparam("dispatcher", "ds_ping_interval", 10)
modparam("dispatcher", "ds_probing_mode", 1)

# ----- statistics -----
modparam("statistics", "variable", "active_calls")

####### Routing Logic ########

request_route {
    # Per-request logging
    xlog("L_INFO", "Received $rm from $fu to $tu\n");

    # Max forwards check
    if (!mf_process_maxfwd_header("10")) {
        sl_send_reply("483", "Too Many Hops");
        exit;
    }

    # Sanity checks
    if (!sanity_check()) {
        xlog("L_WARN", "Malformed SIP message from $si\n");
        exit;
    }

    # Handle CANCEL
    if (is_method("CANCEL")) {
        if (t_check_trans()) {
            route(RELAY);
        }
        exit;
    }

    # Handle responses
    if (t_check_trans()) {
        t_relay();
        exit;
    }

    # Record route for dialogs
    if (is_method("INVITE")) {
        record_route();
        setflag(4); # Dialog flag
    }

    # Handle in-dialog requests
    if (has_totag()) {
        if (loose_route()) {
            route(RELAY);
        } else {
            sl_send_reply("404", "Not Found");
        }
        exit;
    }

    # Auth for INVITE
    if (is_method("INVITE")) {
        # Carrier auth via Voice Switch API
        route(AUTH_CARRIER);
        
        # LCR routing
        route(LCR_ROUTE);
    }

    # Registration pass-through to Class 5
    if (is_method("REGISTER")) {
        route(FORWARD_TO_CLASS5);
        exit;
    }

    route(RELAY);
}

route[AUTH_CARRIER] {
    # Authenticate carrier via IP or digest
    if (!allow_source_address()) {
        if (!www_authorize("brivas", "carriers")) {
            www_challenge("brivas", "0");
            exit;
        }
        consume_credentials();
    }
    xlog("L_INFO", "Carrier authenticated from $si\n");
}

route[LCR_ROUTE] {
    # Use drouting for LCR
    if (!do_routing("0")) {
        xlog("L_ERR", "No route found for $rU\n");
        sl_send_reply("404", "No Route");
        exit;
    }
    
    # Apply RTPEngine for media
    rtpengine_offer("replace-origin replace-session-connection");
    
    # Update stats
    update_stat("active_calls", "+1");
}

route[FORWARD_TO_CLASS5] {
    # Forward registrations to OpenSIPS
    $du = "sip:opensips:5080";
    route(RELAY);
}

route[RELAY] {
    if (!t_relay()) {
        sl_reply_error();
    }
}

onreply_route[MANAGE_REPLY] {
    if (has_body("application/sdp")) {
        rtpengine_answer("replace-origin replace-session-connection");
    }
}

failure_route[FAILOVER] {
    # Failover to next gateway
    if (t_is_canceled()) {
        exit;
    }
    
    if (t_check_status("5[0-9][0-9]")) {
        xlog("L_INFO", "Gateway failed, trying next\n");
        if (use_next_gw()) {
            t_on_failure("FAILOVER");
            route(RELAY);
        }
    }
}
