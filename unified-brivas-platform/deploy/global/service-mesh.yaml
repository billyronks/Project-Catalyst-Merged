# Global Service Mesh Architecture
# Cross-PoP communication and traffic management

apiVersion: brivas.io/v1
kind: ServiceMesh
metadata:
  name: brivas-global-mesh

spec:
  # ============================================================================
  # GLOBAL TRAFFIC LAYER
  # ============================================================================
  globalTraffic:
    geoDns:
      provider: cloudflare  # Or Route53, NS1
      domain: api.brivas.io
      healthCheck:
        protocol: HTTPS
        port: 443
        path: /health
        interval: 10s
        timeout: 5s
        unhealthyThreshold: 3
        
    anycast:
      enabled: true
      ipv4Prefix: 102.217.214.0/24
      ipv6Prefix: 2001:db8:brivas::/48

  # ============================================================================
  # CLUSTER MESH (CILIUM)
  # ============================================================================
  clusterMesh:
    enabled: true
    
    # Tier-1 PoPs full mesh
    tier1Connections:
      - from: lagos-ng-1
        to: [johannesburg-za-1, london-uk-1, frankfurt-de-1, singapore-sg-1, saopaulo-br-1]
      - from: johannesburg-za-1
        to: [lagos-ng-1, london-uk-1, frankfurt-de-1, singapore-sg-1, saopaulo-br-1]
      - from: london-uk-1
        to: [lagos-ng-1, johannesburg-za-1, frankfurt-de-1, singapore-sg-1, saopaulo-br-1]
      - from: frankfurt-de-1
        to: [lagos-ng-1, johannesburg-za-1, london-uk-1, singapore-sg-1, saopaulo-br-1]
      - from: singapore-sg-1
        to: [lagos-ng-1, johannesburg-za-1, london-uk-1, frankfurt-de-1, saopaulo-br-1]
      - from: saopaulo-br-1
        to: [lagos-ng-1, johannesburg-za-1, london-uk-1, frankfurt-de-1, singapore-sg-1]
        
    # Tier-2 connect to parent only
    tier2Connections:
      - from: nairobi-ke-1
        to: [lagos-ng-1]
      - from: cairo-eg-1
        to: [lagos-ng-1]
      - from: dubai-ae-1
        to: [frankfurt-de-1]
      - from: mumbai-in-1
        to: [singapore-sg-1]
      - from: tokyo-jp-1
        to: [singapore-sg-1]

  # ============================================================================
  # SERVICE DISCOVERY
  # ============================================================================
  serviceDiscovery:
    mode: global
    
    # Services available across all PoPs
    globalServices:
      - api-gateway
      - smsc
      - ussd-gateway
      - unified-messaging-hub
      
    # Services with affinity (prefer local)
    affinityServices:
      - billing-service
      - user-service
      - analytics-service

  # ============================================================================
  # CROSS-POP ROUTING POLICIES
  # ============================================================================
  routingPolicies:
    # Default: route to nearest healthy PoP
    default:
      strategy: geo-proximity
      fallbackStrategy: least-latency
      
    # SMPP: session affinity required
    smsc:
      strategy: session-affinity
      affinityTimeout: 3600s
      fallbackStrategy: geo-proximity
      
    # USSD: session affinity required
    ussd-gateway:
      strategy: session-affinity
      affinityTimeout: 180s
      fallbackStrategy: geo-proximity
      
    # Billing: prefer local for consistency
    billing-service:
      strategy: local-first
      allowCrossRegion: true
      crossRegionLatencyThreshold: 100ms

  # ============================================================================
  # FAILOVER CONFIGURATION
  # ============================================================================
  failover:
    enabled: true
    
    # Automatic failover triggers
    triggers:
      unhealthyThreshold: 3
      latencyThreshold: 500ms
      errorRateThreshold: 0.05
      
    # Failover behavior
    behavior:
      mode: automatic
      waitTime: 30s
      drainTimeout: 60s
      
    # Tier-1 failover order
    tier1Failover:
      lagos-ng-1: [johannesburg-za-1, london-uk-1]
      johannesburg-za-1: [lagos-ng-1, london-uk-1]
      london-uk-1: [frankfurt-de-1, lagos-ng-1]
      frankfurt-de-1: [london-uk-1, singapore-sg-1]
      singapore-sg-1: [tokyo-jp-1, frankfurt-de-1]
      saopaulo-br-1: [london-uk-1, lagos-ng-1]
      
    # Tier-2 failover to parent
    tier2Failover:
      nairobi-ke-1: [lagos-ng-1, johannesburg-za-1]
      cairo-eg-1: [lagos-ng-1, frankfurt-de-1]
      dubai-ae-1: [frankfurt-de-1, singapore-sg-1]
      mumbai-in-1: [singapore-sg-1, tokyo-jp-1]
      tokyo-jp-1: [singapore-sg-1, mumbai-in-1]

  # ============================================================================
  # LOAD BALANCING
  # ============================================================================
  loadBalancing:
    # Global load balancing algorithm
    algorithm: weighted-round-robin
    
    # Weight based on capacity
    weightCalculation:
      factors:
        - name: available-capacity
          weight: 0.4
        - name: current-load
          weight: 0.3
        - name: latency
          weight: 0.2
        - name: error-rate
          weight: 0.1
          
    # Health-based weight adjustment
    healthAdjustment:
      unhealthy: 0
      degraded: 0.5
      healthy: 1.0
